---
title: "Analysis of symptoms at presentation in Lassa fever dataset"
---

Lassa "mock" data
```{r}
library(dplyr)
library(stringr)
library(purrr)
library(questionr)
library(naniar)
library(ggplot2)
library(Rmisc)
library(ggpubr)
library(tidyr)
library(textclean)
```

```{r}
filename = "C:/Users/kelse/Documents/Year_2/Rotations/Colubri/Lassa_virus/practice_data/commcare-randomized-data-2018-2020.csv"

lassa <- read.csv(filename, header = TRUE, sep = ",")
```


Subset symptom data collected during admission.

```{r}
dur <- lassa %>%
  select(contains("_during_admission"))

names(dur) <-  mgsub(names(dur), c(
  "clinical_factors.before_admission_bleeding_question_group.bleeding_duration.",
  "_during_admission",
  "clinical_factors.during_admission_symptom_duration.",
  "clinical_factors.additional_clinical_feature_duration.",
  "complications.complications_duration.",
  "_duration.symptom"), c("", "", "", "", "", ""))

# remove medication and "other" symptoms
dur <- dur[,-c(1:2,12,31,53:55)]
```

Convert all values containing "d1" to 1.

```{r}
dur <- map_df(dur, function(x) ifelse(grepl("d1", x), 1, 0))
```

Combine some variables as described in Okokhere et al.
Severe CNS features = coma, seizure, tremors, confusion 
Non-severe CNS features = dizziness, lethargy, drowsiness (no lethargy or drowsiness in this dataset)

bleeding_all = eyes_bleeding, hematemesis (vomiting blood), hematochezia (blood in stool), hemoptysis (coughing up blood), injection_sites_bleeding, mouth_bleeding, nostril_bleeding, vaginal_bleeding, other_bleeding

```{r}
#subset bleeding variables and sum values in new variable, don't include eyes_bleeding
bleeding <-  dur[,c("eyes_bleeding", "hematemesis_bleeding", "hematochezia_bleeding", "hemoptysis_bleeding", "injection_sites_bleeding", "mouth_bleeding", "nostrils_bleeding", "vaginal_bleeding")]
bleeding <- data.frame(rowSums(bleeding))
bleeding[bleeding > 1] <- 1

#subset severe cns variables and sum values in new variable
severe_cns <- dur[,c("coma", "seizures", "tremors", "confusion")]
severe_cns <- data.frame(rowSums(severe_cns))
severe_cns[severe_cns > 1] <- 1
```

Remove bleeding and severe cns variables and replace with grouped variables.

```{r}
dur <- dur[,-c(1,2,3,5,6,7,8,9)] # bleeding variables
dur <- dur[,-c(4,17,32,40)] # severe cns variables

dur <- data.frame("outcome" = lassa$clinical_outcome.outcome,
           "bleeding" = bleeding,
           "severe_cns" = severe_cns,
           dur)

dur <-  rename_with(dur, ~gsub("rowSums.", "", .x))
```

Remove variables where all values are 0 and output list of symptoms that are removed.

```{r}
names(dur[, colSums(dur != 0) == 0])

dur <-dur[, colSums(dur != 0) > 0]
```


Make separate data frames for survived, died, and all patients with known outcome. 

Calculate totals and percents of people who experienced each symptom for all, died, and survived.

```{r}
survived_bin <- dur[grep("recovered", dur$outcome), ]
died_bin <- dur[grep("died", dur$outcome), ]
all_bin <- rbind(survived_bin, died_bin)

#First save all the tables as variables - this gives the total number of patients experiencing each symptom
#select the second element of the table for each variable
all_total <- map(map(all_bin, table), 2)
S_total <- map(map(survived_bin, table), 2)
D_total <- map(map(died_bin, table), 2)

#Remove first row
all_total <- all_total[-1]
S_total <- S_total[-1]
D_total <- D_total[-1]
cfba_binary <- names(dur)
cfba_binary <- cfba_binary[-1]

#Replace NULL values with o
all_total[all_total == "NULL"] <- 0
S_total[S_total == "NULL"] <- 0
D_total[D_total == "NULL"] <- 0

#Save percent data in variable

all_percent <- round(unlist(all_total)/nrow(all_bin), 2)*100
S_percent <- round(unlist(S_total)/nrow(survived_bin), 2)*100
D_percent <- round(unlist(D_total)/nrow(died_bin), 2)*100

#OI_percent_list <- map(map(all, function(x) prop.table(table(x))), 2)
#S_percent_list <- map(map(survived, function(x) prop.table(table(x))), 2)
#D_percent_list <- map(map(died, function(x) prop.table(table(x))), 2)

#unlist percent data, multiply by 100, round
#OI_percent <- round(unlist(OI_percent_list) * 100, 0)
#S_percent <- round(unlist(S_percent_list) * 100, 0)
#D_percent <- round(unlist(D_percent_list) * 100, 0)
```

Make strings to report data.
```{r}
all_string <- paste(all_total,"/",nrow(all_bin)," (",all_percent,"%)", sep="")
surv_string <- paste(S_total,"/",nrow(survived_bin)," (",S_percent,"%)", sep="")
died_string <- paste(D_total,"/",nrow(died_bin)," (",D_percent,"%)", sep="")
```

Reformat outcome variable as an ordered factor 

```{r}
all_bin[all_bin == "died"] <- 1
all_bin[all_bin == "recovered"] <- 0
all_bin <- data.frame(map(all_bin, as.factor)) #convert variables to factor
all_bin$outcome <- ordered(all_bin$outcome)
```

Create separate logistic regression model for each variable and calculate odds ratios by exponentiating coefficients.

```{r}
glm <- map(all_bin, function(x) glm(outcome ~ x, data = all_bin, family = binomial))
odds_df <- data.frame(map(glm[-1], coefficients))
odds_vector <- exp(as.vector(odds_df[-1,]))
odds_rounded_list <- as.list(round(odds_vector,2))

#Calculate p-values for odds ratios
p_value_list <- map(map(glm[-1], odds.ratio), "p")
p_value <- map(map(p_value_list, 2), function(x) round(x, 5))
```

Create a summary table of the data.

```{r}
binary_table <- data.frame(cbind(cfba_binary, all_string, surv_string,  died_string, as.character(p_value), as.character(odds_rounded_list)))
names(binary_table) <- c("Symptom", "Overall", "Survived", "Died", "p_value", "odds_ratio") 
binary_table <- binary_table %>%
  arrange(p_value)
binary_table

# save output in csv file
dir.create("lassa_fever_analysis")
write.csv(binary_table, "./lassa_fever_analysis/symptoms_at_presentation.csv")
```

```{r}
p <- round(data.frame(unlist(p_value)), 6)
newdata <- cbind(cfba_binary, OP =  all_percent, SP =  S_percent, DP =  D_percent, p = p)
names(newdata) <- c("name", "Overall", "Survived", "Died",  "p")
```

Order according to increasing p value and generate bar plot
```{r}
newdata$name <- factor(newdata$name, levels = newdata$name[order(newdata$p)])

nd <- newdata %>%
  gather("Type", "Value", -name)

Type = c("Overall", "Died", "Survived", "p")
nd$Type <- factor(nd$Type, ordered = TRUE,  levels = Type)
```

```{r}
p <- ggplot(subset(nd, Type %in% c("Overall" , "Died", "Survived")), aes(name, Value, fill = Type)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  scale_fill_manual(values=c("palegreen3", "coral2", "steelblue2")) +
  theme_bw() +
  ylab("Prevalence (%)") +
  xlab("Complication during treatment in hospital") +
  ylim(0, 100) +
  ggtitle("Prevalence of complications in patients diagnosed with Lassa fever") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p

# save output to pdf
pdf("./lassa_fever_analysis/symptoms_at_presentation_prevalence.pdf")
p
dev.off()
```


