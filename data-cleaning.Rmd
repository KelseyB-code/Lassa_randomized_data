```{r}
library(dplyr)
library(stringr)
library(purrr)

# load data 

filename = "C:/Users/Matt/OneDrive/Desktop/Kelsey/Data/commcare-cleaned-data-2018-2020.csv"
lassa <- read.csv(filename)

age <- lassa$basic_information.age
sex <- lassa$basic_information.sex
pcrct <- lassa$pcr_list.pcr_cycle_threshold.0
dofbp <- lassa$clinical_features.before_admission_group.before_admission_symptom_duration.fever_duration.symptom_before_admission %>%
  str_count("D")	
temp <- lassa$clinical_features.at_admission_group.vital_signs.at_admission_temperature
sbp	<- lassa$clinical_features.at_admission_group.vital_signs.at_admission_systolic_blood_pressure
dbp	<- lassa$clinical_features.at_admission_group.vital_signs.at_admission_diastolic_blood_pressure
pr <- lassa$clinical_features.at_admission_group.vital_signs.at_admission_pulse_rate
rr <- lassa$clinical_features.at_admission_group.vital_signs.at_admission_respiratory_rate
temp_max <- lassa$clinical_factors.vital_signs.max_temperature.d1
pr_max <- lassa$clinical_factors.vital_signs.max_pulse_rate.d1
sbp_max <- lassa$clinical_factors.vital_signs.max_systolic_blood_pressure.d1
dbp_max <- lassa$clinical_factors.vital_signs.max_diastolic_blood_pressure.d1
rr_max <- lassa$clinical_factors.vital_signs.max_respiratory_rate.d1

####################################################################################################
# Group variables for severe cns and bleeding

dur <- lassa %>%
  select(contains("_during_admission"))
dur <- map_df(dur, function(x) ifelse(grepl("d1", x), 1, 0))

bleeding_vars <- c("eyes_bleeding", "hematemesis_bleeding", "hematochezia_bleeding", "hemoptysis_bleeding", "injection_sites_bleeding", "mouth_bleeding", "nostrils_bleeding", "vaginal_bleeding", "other_bleeding")
scns_vars <- c("coma", "seizures", "tremors", "confusion")

bleeding <- dur %>%
  select(contains(bleeding_vars))
bleeding <- data.frame(rowSums(bleeding))
bleeding[bleeding > 1] <- 1
blding <- bleeding$rowSums.bleeding.

# subset severe cns variables and sum values in new variable
scns <- dur %>%
  select(contains(scns_vars))
scns <- data.frame(rowSums(scns))
scns[scns > 1] <- 1
scns <- scns$rowSums.scns.

# define other binary variables
out <- lassa$clinical_outcome.outcome
sthr <- dur$clinical_factors.during_admission_symptom_duration.sore_throat_duration.symptom_during_admission
coug <- dur$clinical_factors.during_admission_symptom_duration.cough_duration.symptom_during_admission
vomit <- dur$clinical_factors.during_admission_symptom_duration.vomiting_duration.symptom_during_admission
diarr <- dur$clinical_factors.during_admission_symptom_duration.diarrhea_duration.symptom_during_admission
head <- dur$clinical_factors.during_admission_symptom_duration.headache_duration.symptom_during_admission
abdp <- dur$clinical_factors.during_admission_symptom_duration.abdominal_pain_duration.symptom_during_admission
chesp <- dur$clinical_factors.during_admission_symptom_duration.chest_pain_duration.symptom_during_admission
weak <- dur$clinical_factors.during_admission_symptom_duration.weakness_duration.symptom_during_admission
jaun <- dur$clinical_factors.during_admission_symptom_duration.jaundice_duration.symptom_during_admission
reyes <- dur$clinical_factors.during_admission_symptom_duration.red_eyes_duration.symptom_during_admission
swell <- dur$clinical_factors.during_admission_symptom_duration.face_or_neck_swelling_duration.symptom_during_admission
ribav <- lassa$special_interventions.treatment.ribavirin
dial <- lassa$special_interventions.dialysis
prot <- lassa$protein.urine_protein_yes_no.0
hema <- lassa$blood.urine_blood_yes_no.0

ribav[is.na(ribav)] <- 0
dial[is.na(dial)] <- 0
prot[is.na(prot)] <- 0
hema[is.na(hema)] <- 0

################################################################################################
# only include blood chemistry tests administered within one day of admission
lassa1 <- lassa %>%
  dplyr::mutate(across(starts_with("blood"),
                      ~ifelse(blood_chemistry_list.days_since_admission_of_test.0 %in% 
                                c("0 days", "1 days"), ., NA))) %>%
  dplyr::mutate(across(starts_with("hematology"),
                      ~ifelse(hematology_list.days_since_admission_of_test.0 %in% 
                                c("0 days", "1 days"), ., NA))) %>%
  dplyr::mutate(across(starts_with("pcr"),
                      ~ifelse(pcr_list.days_since_admission_of_test.0 %in% 
                                c("0 days", "1 days"), ., NA)))

esr <- lassa1$hematology_list.erythrocyte_sedimentation_rate.0
k <- lassa1$blood_chemistry_list.potassium.0
na <- lassa1$blood_chemistry_list.sodium.0
alk <- lassa$blood_chemistry_list.alkaline_phosphatase.0
tpro <- lassa1$blood_chemistry_list.total_protein.0
alb <- lassa1$blood_chemistry_list.albumin.0
tbil <- lassa1$blood_chemistry_list.total_bilirubin.0
ast <- lassa1$blood_chemistry_list.aspartate_aminotransferase_ast.0
alt <- lassa1$blood_chemistry_list.alaninea_aminotransferas_alt.0
bun <- lassa1$blood_chemistry_list.blood_urea_nitrogen.0
cre <- lassa1$blood_chemistry_list.creatinine.0
wbc <- lassa1$hematology_list.white_cell_count.0
hct <- lassa1$hematology_list.haematocrit_concentration.0
plt <- lassa1$hematology_list.platelet.0
lym <- lassa1$hematology_list.lymphocytes.0
mon <- lassa1$hematology_list.monocytes.0
gra <- lassa1$hematology_list.granulocytes_neutrophils.0

########################################################################################################33
# reformat variables

sex <- case_when(sex == "male" ~ 0,
          sex == "female" ~ 1)

out <- case_when(out == "recovered" ~ 0,
          out == "died" ~ 1)

ribav <- case_when(ribav == "no" ~ 0,
          ribav == "yes" ~ 1)

dial <- case_when(dial == "no" ~ 0,
          dial == "yes" ~ 1)

prot <- case_when(prot == "no" ~ 0,
          prot == "yes" ~ 1)

hema <- case_when(hema == "no" ~ 0,
          hema == "yes" ~ 1)

pcrct <- ifelse(pcrct > 60, NA, pcrct)

#############################################################################################################
# save data
new <- data.frame(cbind(age, pcrct, dofbp, temp, sbp, dbp, pr, rr, temp_max, sbp_max, dbp_max, rr_max, esr, k,  na, alk, tpro, alb, tbil, ast, alt, bun, cre, wbc, hct, plt, lym, mon, gra, sex, scns, blding, sthr, coug, vomit, diarr, head, abdp, chesp, weak, jaun, reyes, swell, ribav, dial, prot, hema, out))

new <- new %>% mutate_all(na_if,"")

write.csv(new, "2018-cleaned.csv", row.names = F)
```
