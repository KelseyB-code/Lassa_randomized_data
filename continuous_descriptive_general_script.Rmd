---
title: "Calculating mean, 95% CI, and odds ratios for continuous variables"
subtitle: Lassa virus data set, February 2021
---

This contains code for descriptive analysis of continuous/numeric variables. Start with data frame titled "num" that contains outcome data in first column with header "outcome." Format as a factor variable with two levels: recovered and died. 

Remove observations for which outcome is unknown.
```{r}
num <- filter(num, grepl('recovered|died', outcome))

#Create new data frames for survived and died outcomes
died <- num[grep("died", num$outcome),]
survived <- num[grep("recovered", num$outcome),]
```

Calculate mean and 95% CI for survived, died, and all.

```{r}
mean_died <- map(died[-1], function (x) CI((na.omit(x, ci=.95))))
mean_survived <- map(survived[-1], function (x) CI((na.omit(x, ci=.95))))

mean_s <- round(unlist(map(mean_survived, "mean")), 2)
upper_s <- round(unlist(map(mean_survived, "upper")), 2)
lower_s <- round(unlist(map(mean_survived, "lower")), 2)

mean_d <- round(unlist(map(mean_died, "mean")), 2)
upper_d <- round(unlist(map(mean_died, "upper")), 2)
lower_d <- round(unlist(map(mean_died, "lower")), 2)

mean_CI_survived_string <- paste(mean_s, " (",lower_s,"-",upper_s,")",sep = "")
mean_CI_died_string <- paste(mean_d, " (",lower_d,"-",upper_d,")",sep = "")
```

Calculate missing observations and percent missing for each variable.

```{r}
missing <- unlist(map(num, function(x) sum(is.na(x))))
missing_percent <- round(missing/nrow(num) *100,  0)

missing_string <- paste(missing, " (",missing_percent,"%)",sep = "")
```

Divide age by 10 and other variables by IQR. Then calculate odds ratio. 
```{r}
num_scaled <-  cbind("outcome" = num$outcome,
                     "age" = num$age/10, 
                     data.frame(map(num[3:16], function(x) x/IQR(x,na.rm = TRUE))))

glm <- map(num_scaled[-1], function(x) glm(outcome ~ x, data = num_scaled, family = binomial))
```

Calculate odds ratio for each variable

map() makes a list.
map_lgl() makes a logical vector.
map_int() makes an integer vector.
map_dbl() makes a double vector.
map_chr() makes a character vector.

```{r}
num_scaled %>% 
 split(.$outcome) 
 map(~lm(gdpPercap ~ lifeExp, data = .))
```


```{r}
odds <- map(glm, odds.ratio)

odds_CI_2.5 <- map_dbl(map(odds, "2.5 %"), 2)
odds_CI_2.5
odds_CI_97.5 <- map_dbl(map(odds, "97.5 %"), 2)
OR <- map(map(odds, "OR"), 2)
p_value_long <- map_dbl(map(odds, "p"), 2)
p_value_long
p_value <- round(unlist(p_value_long), 5)

```

```{r}
mean_CI_survived_string
mean_CI_died_string
missing_string
odds
p_value
```

